<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Reporte Financiero (Balance, Estado de Resultados,
	Indicadores)</title>
<link rel="stylesheet"
	href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
<link rel="stylesheet" th:href="@{/css/estilos.css}">

<!-- Flatpickr CSS -->
<link rel="stylesheet"
	href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">

</head>

<body class="container mt-4">

	<h2 class="text-center">Reporte Financiero</h2>

	<!-- Formulario para ingresar Código de Entidad y Fecha -->
	<form id="formularioReporte" class="mt-3" method="GET"
		action="/reportes/financieros-estado-resultados/datos">
		<div class="mb-3">
			<label for="codigoEntidad" class="form-label">Código de
				Entidad</label> <input type="number" class="form-control" id="codigoEntidad"
				name="codigoEntidad" required>
		</div>
		<div class="mb-3">
			<label for="fechaMayor" class="form-label">Fecha Mayor</label> <input
				type="date" class="form-control" id="fechaMayor" name="fechaMayor"
				required>
		</div>
		<button type="submit" class="btn btn-primary" id="btnConsultar">Consultar
			Reporte</button>
		<div id="spinner" class="text-center mt-3" style="display: none;">


			<!-- Indicador de progreso -->
			<div class="spinner-border text-primary" role="status">
				<span class="visually-hidden">Cargando...</span>
			</div>
			<p>Cargando reporte, por favor espere...</p>
		</div>

	</form>

	<!-- Mostrar la tabla solo si hay datos -->
	<div class="mt-4" th:if="${datosReporte}">
		<p class="texto-nota">Cifras en millones de pesos y porcentajes</p>

		<table class="table table-bordered table-striped">
			<thead class="table-dark">
				<tr>
					<th>Nombre Cuenta</th>
					<th>Código PUC</th>
					<th th:text="${fechaFormateada}">Valor Actual</th>
					<th th:text="${fechaMenorFormateada}">Valor Anterior</th>
					<th>% Participación</th>
					<th>% Variación Trimestral</th>
				</tr>
			</thead>
			<tbody>
				<tr th:each="fila : ${datosReporte}"
					th:class="${#strings.endsWith(fila.Codigo, '00000')} ? 'fila-clase' : ''">
					<td th:text="${fila['Nombre_Cuenta']}"></td>
					<td
						th:text="${fila['Codigo'] != null and fila['Codigo'] != '' ? fila['Codigo'] : '-'}"></td>

					<td
						th:text="${fila['Valor_Actual_Millones'] != null ? fila['Valor_Actual_Millones'] : '-'}"></td>
					<td
						th:text="${fila['Valor_Anterior_Millones'] != null ? fila['Valor_Anterior_Millones'] : '-'}"></td>


					<td
						th:text="${fila['Porcentaje_Participacion_Actual'] != null 
  ? #numbers.formatDecimal(fila['Porcentaje_Participacion_Actual'], 1, 'COMMA', 2, 'POINT') 
  : '-'}"></td>

					<td
						th:text="${fila['Variacion_Anual'] != null 
  ? #numbers.formatDecimal(fila['Variacion_Anual'], 1, 'COMMA', 2, 'POINT') 
  : '-'}"></td>

				</tr>
			</tbody>

		</table>
		<p class="texto-nota">Incluye resultados de ejercicios anteriores</p>

		<!-- Botón para descargar el reporte en Excel -->
		<a class="btn btn-success"
			th:href="@{/api/teradata/reporte/excel(codigoEntidad=${codigoEntidad}, fechaMayor=${fechaMayor})}">
			Descargar Reporte en Excel </a>
	</div>
	<div class="col-md-6">
		<h3>Estado de Resultados</h3>
		<table class="table table-bordered">
			<thead>
				<tr>
					<th>Concepto</th>
					<th th:text="${cabActual}">Actual</th>
					<th th:text="${cabT3}">-3 meses</th>
					<th th:text="${cabT12}">-12 meses</th>
					<th>Var. Trimestral (%)</th>
					<th>Var. Anual (%)</th>
				</tr>
			</thead>
			<tbody>
				<tr th:each="fila : ${estadoResultados}"
					th:classappend="${fila['esTotal'] == true} ? ' total-row'">
					<td th:text="${fila['Grupo']}"></td>
					<td
						th:text="${fila['actual'] == null ? '-' :
            (fila['actual'] < 0 ? '(' + #numbers.formatDecimal(-fila['actual'], 1, 'COMMA', 2, 'POINT') + ')'
                                :      #numbers.formatDecimal(fila['actual'],   1, 'COMMA', 2, 'POINT'))}">
					</td>

					<td
						th:text="${fila['tresMeses'] == null ? '-' :
            (fila['tresMeses'] < 0 ? '(' + #numbers.formatDecimal(-fila['tresMeses'], 1, 'COMMA', 2, 'POINT') + ')'
                                   :      #numbers.formatDecimal(fila['tresMeses'],   1, 'COMMA', 2, 'POINT'))}">
					</td>

					<td
						th:text="${fila['unAnio'] == null ? '-' :
            (fila['unAnio'] < 0 ? '(' + #numbers.formatDecimal(-fila['unAnio'], 1, 'COMMA', 2, 'POINT') + ')'
                                :      #numbers.formatDecimal(fila['unAnio'],   1, 'COMMA', 2, 'POINT'))}">
					</td>

					<!-- Porcentajes; si null, muestra '-' -->
					<td
						th:text="${fila['varTrim'] == null ? '-' : #numbers.formatDecimal(fila['varTrim'], 1, 'COMMA', 2, 'POINT')}"></td>
					<td
						th:text="${fila['varAnual'] == null ? '-' : #numbers.formatDecimal(fila['varAnual'], 1, 'COMMA', 2, 'POINT')}"></td>
				</tr>
			</tbody>
		</table>
	</div>
	<!-- Flatpickr -->
	<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
	<script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/es.js"></script>

	<script>
		// Solo habilita días fin de mes
		flatpickr("#fechaMayor", {
			dateFormat : "Y-m-d",
			locale : "es",
			disable : [ function(date) {
				const nextDay = new Date(date);
				nextDay.setDate(date.getDate() + 1);
				return nextDay.getMonth() === date.getMonth();
			} ]
		});
		document.getElementById("formularioReporte").addEventListener("submit",
				function() {
					document.getElementById("btnConsultar").disabled = true;
					document.getElementById("spinner").style.display = "block";
				});
	</script>

</body>
</html>
